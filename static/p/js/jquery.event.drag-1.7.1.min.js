/** javascript **/

//초기화
$(document).ready(function(){
    init();
});

//파일 Drag&Drop 업로드(초기화 시 EventListener를 부여하는 방식)
const init = () => {
    const sec = document.querySelector('#data_file');
    // const btnUpload = sec.querySelector('.btn_uplode');
    // const inputFile = sec.querySelector('input[type="file"]');
    const uploadBox = sec.querySelector('.file_box');
	
    //Chrome의 경우 DragOver한 파일을 Drop시 해당 파일 내용을 브라우저에 띄워주기 때문에
    //dragover와 drop 이벤트의 기본 기능을 preventDefault를 이용해 막아준다.
    
    uploadBox.addEventListener('dragover', function(e) {
        e.preventDefault();
		//여기에 파일이 위로 지나갈때마다 적용되는 이벤트를 넣어줄 수 있음.
    });
	
    uploadBox.addEventListener('drop', function (e){
        e.preventDefault();
		
        //DataTransfer로 받아올 수 있음
        const data = e.dataTransfer;

        //유효성 검사
        if(!isValid(data)) {
			return;
		}

        //* Drag&Drop 된 파일을 input file의 내용으로 교체
        $('#testFile')[0].files = data.files;


		//파일이 있는 경우 text 교체
		$('#testFileNm').text(data.files[0] != null ? data.files[0].name : '여기에 csv 파일을 놓거나 클릭하세요');

		//태깅버튼 활성화
		$('#tag_btn').removeClass('disable');
		$('#tag_btn').attr('disabled',false);

		//태깅버튼 박스 보이기, 다운로드 버튼 숨기기
		$("#tag_box").show();
		$("#download_box").hide();


    });

}

// testFile 변경시 작동되는 이벤트
$(function() {
	$("#testFile").change(function(e){
		
		var data = $('input[type=file]')[0].files[0];
		
        //유효성 검사_1
        if(!uploadFile(data)) {
			return;
		}
		
		//* Drag&Drop 된 파일을 input file의 내용으로 교체
		$('#testFile')[0].files = data.files;
		//파일이 있는 경우 text 교체
		$('#testFileNm').text(data.name);

		//태깅버튼 활성화
		$('#tag_btn').removeClass('disable');
		$('#tag_btn').attr('disabled',false);

		//태깅버튼 박스 보이기, 다운로드 버튼 숨기기
		$("#tag_box").show();
		$("#download_box").hide();

    });

});


// 버튼 클릭시 파일 유효성 검사
 function uploadFile(data) {
	var fileVal = data.name; //파일이름
	var ext = fileVal.split('.').pop().toLowerCase(); //화장자
	//아래 확장자가 있는지 체크
	if($.inArray(ext, ['csv']) == -1) {
		alert("csv 파일만 업로드 가능");
		return false;
	}
	var maxSize = 50 * 1024 * 1024; // 50MB
	var fileSize = data.size;
	if(fileSize > maxSize){
		alert("첨부파일 사이즈는 50MB 이내로 등록 가능합니다.");
		return false;
	}
	return true;
}

// 드래그시 파일 유효성 검사
function isValid(data){
	//파일인지 유효성 검사
	if(data.types.indexOf('Files') < 0)
		return false;
	//파일의 개수는 1개씩만 가능하도록 유효성 검사
	if(data.files.length > 1){
		alert('파일은 하나씩 전송이 가능합니다.');
		return false;
	}
	
	var imgFile = data.files[0].name;
	var fileForm = /(.*?)\.(csv)$/;
	if(!imgFile.match(fileForm)) {
		alert("csv 파일만 업로드 가능");
		return false;
	}

	//파일의 사이즈는 50MB 미만
	if(data.files[0].size >= 1024 * 1024 * 50){
		alert('50MB 이상인 파일은 업로드할 수 없습니다.');
		return false;
	}
	return true;
}


// 태깅버튼 비동기 ajax
$(function() {

	$('#tag_btn').click(function() {
		
		var form = $('#tagging')[0];
		var data = new FormData(form);
		data.append("testFile",$('#testFile').files);
		data.append("filename", $('#testFileNm').text());

		// ajax로 데이터 전송
		$.ajax({   
			url: "/tagging/", // ajax로 데이터 교환할 페이지 주소
			processData : false,
			contentType : false,
			method: "POST",
			data: data,
			success: function(data){ //로직 성공시
				$(".tagging").fadeOut();
				$(".modal").fadeOut();
				
				$("#tag_box").hide();
				$("#download_box").show();
				$("#testFileNm").html(data.filename);
				$("#new_file_name").val(data.filename);
				// console.log($("#testFileNm").text());
			},
			error: function(data){ //로직 실패시

//				alert(data.responseJSON.error);
//				console.log(data.responseJSON.error);
//				$(".tagging").fadeOut();
//				$(".modal").fadeOut();
                var html = "<button type='button' class='btn_Close' onclick='popClose2()'></button><p></p><span>message</span>";
                error_log = html.replace("message", data.responseJSON.error);
                console.log(data.responseJSON.error);
                $(".tagging").html(error_log);
                $(".tagging").fadeIn();
                $(".modal").fadeIn();

			},
			beforeSend: function () { //로딩화면
                var html = "<button type='button' class='btn_Close' onclick='popClose2()'></button><p></p><span>message</span>";
                tagging_message = html.replace("message", "카테고리 태깅중 입니다. <br> 태깅이 완료될 때 까지 현재 창을 유지해 주세요.");
                $(".tagging").html(tagging_message);
				$(".tagging").fadeIn();
				$(".modal").fadeIn();
			},

		});
	});
});
/** javascript **/

//초기화
$(document).ready(function(){
    init();
});

//파일 Drag&Drop 업로드(초기화 시 EventListener를 부여하는 방식)
const init = () => {
    const sec = document.querySelector('#data_file');
    // const btnUpload = sec.querySelector('.btn_uplode');
    // const inputFile = sec.querySelector('input[type="file"]');
    const uploadBox = sec.querySelector('.file_box');
	
    //Chrome의 경우 DragOver한 파일을 Drop시 해당 파일 내용을 브라우저에 띄워주기 때문에
    //dragover와 drop 이벤트의 기본 기능을 preventDefault를 이용해 막아준다.
    
    uploadBox.addEventListener('dragover', function(e) {
        e.preventDefault();
		// 최승언: 여기에 파일이 위로 지나갈때마다 적용되는 이벤트를 넣어주면 좋을 것 같습니다. 예를 들어 테두리 색깔이 변한다든지
    });
	
    uploadBox.addEventListener('drop', function (e){
        e.preventDefault();
		
        //DataTransfer로 받아올 수 있음
        const data = e.dataTransfer;

        //유효성 검사_1
        // if(!isCSV(data)) {
			// return;
		// }
		
        //유효성 검사_2
        if(!isValid(data)) {
			return;
		}

        //* Drag&Drop 된 파일을 input file의 내용으로 교체
        $('#testFile')[0].files = data.files;


		//파일이 있는 경우 text 교체
		$('#testFileNm').text(data.files[0] != null ? data.files[0].name : '여기에 csv 파일을 놓거나 클릭하세요');		

		//버튼 숨기기
		// $(btnUpload).hide();

		//태깅버튼 활성화
		$('#tag_btn').removeClass('disable');
		$('#tag_btn').attr('disabled',false);

    });

}

$(function() {
	$("#testFile").change(function(e){
		
		var data = $('input[type=file]')[0].files[0];
		
        //유효성 검사_1
        if(!uploadFile(data)) {
			return;
		}
		
		
		//유효성 검사 완료후 파일이 있는 경우 text 교체
		// if ($("#testFile").val() != ""){
			
			//* Drag&Drop 된 파일을 input file의 내용으로 교체
			// $('#testFile')[0].files = data.files;
			//파일이 있는 경우 text 교체
			// $('#testFileNm').text(data.name);

			//태깅버튼 활성화
			// $('#tag_btn').removeClass('disable');
			// $('#tag_btn').attr('disabled',false);
		// }
		
		//* Drag&Drop 된 파일을 input file의 내용으로 교체
		$('#testFile')[0].files = data.files;
		//파일이 있는 경우 text 교체
		$('#testFileNm').text(data.name);

		//태깅버튼 활성화
		$('#tag_btn').removeClass('disable');
		$('#tag_btn').attr('disabled',false);
		

    });

});


// 버튼 클릭시 파일 유효성 검사
 function uploadFile(data) {
	var fileVal = data.name; //파일이름
	var ext = fileVal.split('.').pop().toLowerCase(); //화장자
	//아래 확장자가 있는지 체크
	if($.inArray(ext, ['csv']) == -1) {
		alert("csv 파일만 업로드 가능");
		// $("#testFile").val("");
		return false;
	}
	var maxSize = 50 * 1024 * 1024; // 50MB
	var fileSize = data.size;
	if(fileSize > maxSize){
		alert("첨부파일 사이즈는 50MB 이내로 등록 가능합니다.");
		// $("#testFile").val("");
		return false;
	}
	//alert($("#testFile").val());
	return true;
}


// 드래그시 파일형식 유효성 검사
// function isCSV(data){
	// var imgFile = data.files[0].name;
	// var fileForm = /(.*?)\.(csv)$/;
	// if(!imgFile.match(fileForm)) {
		// alert("csv 파일만 업로드 가능");
		// return false;
	// }
	// return true;
// }

// 드래그시 파일개수, 사이즈 유효성 검사
function isValid(data){
	//파일인지 유효성 검사
	if(data.types.indexOf('Files') < 0)
		return false;
	//파일의 개수는 1개씩만 가능하도록 유효성 검사
	if(data.files.length > 1){
		alert('파일은 하나씩 전송이 가능합니다.');
		return false;
	}
	
	var imgFile = data.files[0].name;
	var fileForm = /(.*?)\.(csv)$/;
	if(!imgFile.match(fileForm)) {
		alert("csv 파일만 업로드 가능");
		return false;
	}
	
	//파일의 사이즈는 50MB 미만
	if(data.files[0].size >= 1024 * 1024 * 50){
		alert('50MB 이상인 파일은 업로드할 수 없습니다.');
		return false;
	}
	return true;
}


$(function() {
	$('#return_login').click(function() { //버튼 id
		
	var form = $("#login_check")[0];
	var form_data = new FormData(form);
	
	userID = $("#userID").val();
	password = $("#password").val();
	
	form_data.append("userID", userID);
	form_data.append("password", password);

		// ajax로 데이터 전송
		$.ajax({   
			url: "/ats_login/", // ajax로 데이터 교환할 페이지 주소

			enctype: 'multipart/form-data',
			processData : false,
			contentType : false,
			method: "POST",
			data: form_data,
			success: function(data){ //로직 성공시
				alert("환영합니다. "+userID+"님");
			},

			error: function(data){ //로직 실패시
				$(".al_pop").fadeIn();
				$(".modal").fadeIn();
			},
		});
	});
	
	$('#tag_btn').click(function() {
		
		var form = $('#tagging')[0];
		var data = new FormData(form);
		data.append("testFile",$('#testFile').files);
		data.append("filename", $('#testFileNm').text());

		// ajax로 데이터 전송
		$.ajax({   
			url: "/tagging/", // ajax로 데이터 교환할 페이지 주소

			processData : false,
			contentType : false,
			method: "POST",
			data: data,
			success: function(data){ //로직 성공시
			
				$(".tagging").fadeOut();
				$(".modal").fadeOut();
				
				$("#tag_box").hide();
				$("#download_box").show();
				$("#testFileNm").html(data.filename);
				$("#download_file").val(data.filename);

			},
			error: function(data){ //로직 실패시
				$(".tagging").fadeOut();
				$(".modal").fadeOut();
				alert('태깅에 실패했습니다. 파일형식을 다시 한 번 확인해주세요.');

				console.log('failed: 태깅에 실패했습니다. 파일형식을 다시 한 번 확인해주세요.');
				console.log($('#testFileNm').text());

			},
			beforeSend: function () { //로딩화면
				$(".tagging").fadeIn();
				$(".modal").fadeIn();
			},
		});
	});	
	
});
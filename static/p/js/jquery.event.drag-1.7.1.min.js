/** javascript **/

//초기화
$(document).ready(function(){
    init();
});


//파일 Drag&Drop 업로드(초기화 시 EventListener를 부여하는 방식)
const init = () => {
    const sec = document.querySelector('#data_file');
    const btnUpload = sec.querySelector('.btn_uplode');
    //const inputFile = sec.querySelector('input[type="file"]');
    const uploadBox = sec.querySelector('.file_box');
	
    //Chrome의 경우 DragOver한 파일을 Drop시 해당 파일 내용을 브라우저에 띄워주기 때문에
    //dragover와 drop 이벤트의 기본 기능을 preventDefault를 이용해 막아준다.
    
    uploadBox.addEventListener('dragover', function(e) {
        e.preventDefault();
		// 최승언: 여기에 파일이 위로 지나갈때마다 적용되는 이벤트를 넣어주면 좋을 것 같습니다. 예를 들어 테두리 색깔이 변한다든지
    });
	
    uploadBox.addEventListener('drop', function (e){
        e.preventDefault();
		
        //DataTransfer로 받아올 수 있음
        const data = e.dataTransfer;

        //유효성 검사_1
        if(!isCSV(data)) {
			return;
		}
		
        //유효성 검사_2
        if(!isValid(data)) {
			return;
		}
		$("#txt_stat").html("입출금 구분값과 통장인자적요 컬럼을 업로드 해 주세요.<br><b>처리 가능 데이터는 100만 건</b> 입니다.");

		//* Drag&Drop 된 파일을 input file의 내용으로 교체
		$('#testFile')[0].files = data.files;
		//파일이 있는 경우 text 교체
		$('#testFileNm').text(data.files[0] != null ? data.files[0].name : '여기에 csv 파일을 놓거나 클릭하세요');	
		//+ 버튼 숨기기
		$(btnUpload).hide();
		//태깅버튼 활성화
		$('#tag_btn').removeClass('disable');
    });
}

$(function() {
	$("#testFile").change(function(e){
		
		var data = $('input[type=file]')[0].files[0];
		
        //유효성 검사_1
        if(!uploadFile(data)) {
			return;
		}
		
		else if ($('#testFile').val() != ""){
			//* Drag&Drop 된 파일을 input file의 내용으로 교체
			$('#testFile')[0].files = data.files;
			//파일이 있는 경우 text 교체
			$('#testFileNm').text(data.name);
			//+ 버튼 숨기기
			$(this).hide();
			//태깅버튼 활성화
			$('#tag_btn').removeClass('disable');
		}
    });
	
});


// 버튼 클릭시 파일 유효성 검사
function uploadFile(data) {
	var fileVal = data.name; //파일이름
	var ext = fileVal.split('.').pop().toLowerCase(); //확장자
	//아래 확장자가 있는지 체크
	if($.inArray(ext, ['csv','txt']) == -1) {
		$("#txt_stat").html("csv, txt 파일만 업로드 가능");
		return false;
	}
	var maxSize = 50 * 1024 * 1024; // 50MB
	var fileSize = data.size;
	if(fileSize > maxSize){
		$("#txt_stat").html("첨부파일 사이즈는 50MB 이내로 등록 가능합니다.");
		return false;
	}
	return true;
}



// 드래그시 파일형식 유효성 검사
function isCSV(data){
	var imgFile = data.files[0].name;
	var fileForm = /(.*?)\.(csv|txt)$/;
	if(!imgFile.match(fileForm)) {
		$("#txt_stat").html("csv, txt 파일만 업로드 가능");
		return false;
	}
	return true;
}

// 드래그시 파일개수, 사이즈 유효성 검사
function isValid(data){
	//파일인지 유효성 검사
	if(data.types.indexOf('Files') < 0)
		return false;
	//파일의 개수는 1개씩만 가능하도록 유효성 검사
	if(data.files.length > 1){
		$("#txt_stat").html('파일은 하나씩 전송이 가능합니다.');
		return false;
	}
	//파일의 사이즈는 50MB 미만
	if(data.files[0].size >= 1024 * 1024 * 50){
		$("#txt_stat").html("첨부파일 사이즈는 50MB 이내로 등록 가능합니다.");
		return false;
	}
	return true;
}

$(function() {
	$('#tag_btn').click(function() {
		
		var form = $('#tagging')[0];
		var data = new FormData(form);
		data.append("testFile",$('#testFile').files);
		
		data.append("userID", $('#userID').text())
		data.append("filename", $('#testFileNm').text())

		// ajax로 데이터 전송
		$.ajax({   
			// url: "{% url 'tagging' %}", // ajax로 데이터 교환할 페이지 주소
			url: "/tagging/", // ajax로 데이터 교환할 페이지 주소

			processData : false,
			contentType : false,
			method: "POST",
			data: data,
			success: function(data){ //로직 성공시
				$('.wrap-loading').hide();	
				$("#txt_stat").html(data.message);
				$("#tag_box").hide();
				$("#download_box").show();
				$("#testFileNm").html(data.filename);
				$("#download_file").val(data.filename);

			},
			complete: function(data){ //로직 끝날시
				$('.wrap-loading').hide();	
			},
			error: function(data){ //로직 실패시
				$("#txt_stat").html(data.responseJSON.error);
			},
			beforeSend: function () { //로딩화면
				$("#txt_stat").html("<b>태깅중</b>");
				$("#testFileNm").html("태깅중");
				$('.wrap-loading').show();
			},
		});
	});
});